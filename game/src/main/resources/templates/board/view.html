<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<style>
div.card-content {
border: 1px solid black;
}
</style>

    <head>
        <meta charset="UTF-8">
        <title>The page is a write page</title>
    </head>
    
    <body>
        <div class="card-content">
            <form class="form-horizontal form-view" th:object="${board}">
                <div class="form-group">
                    <label for="inp-type-1" class="col-sm-2 control-label">제목</label>
                    <div class="col-sm-10">
                        <p class="form-control" th:text="*{boardTitle}"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inp-type-2" class="col-sm-2 control-label">이름</label>
                    <div class="col-sm-10">
                        <p class="form-control" th:text="*{memNick}"></p>
                    </div>
                </div>
             
                <div class="form-group">
                    <label for="inp-type-5" class="col-sm-2 control-label">내용</label>
                    <div class="col-sm-10">
                        <p class="form-control" th:text="*{boardContent}"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inp-type-5" class="col-sm-2 control-label">등록일</label>
                    <div class="col-sm-10">
                        <p class="form-control" th:text="*{boardDate}"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="inp-type-5" class="col-sm-2 control-label">조회수</label>
                    <div class="col-sm-10">
                        <p class="form-control" th:text="*{boardHit}"></p>
                    </div>
                </div>
            </form>

            <div class="btn_wrap text-center">
                <a th:href="@{/board/freeboard/list}" class="btn btn-default waves-effect waves-light">뒤로가기</a>
                <a th:href="@{/board/freeboard/write( boardNum=${board.boardNum}, boardType=${board.boardType}, memId=${board.memId} )}" class="btn btn-primary waves-effect waves-light">수정하기</a>
                <button type="button" class="btn btn-danger waves-effect waves-light" th:onclick="deleteBoard([[ ${board.boardNum} ]], [[ ${board.memId} ]], [[ ${board.boardType} ]])">삭제하기</button>
            </div>
        </div>
        <!-- /.card-content -->

        <div class="box-content">
            <div class="card-content">
                <div class="clearfix">
                    <h4 class="box-title pull-left">Comment</h4>
                    <!-- /.box-title -->
                </div>

    <form class="form-horizontal form-view" >
		<div class="input-group margin-bottom-20">
			<input type="text" id="content" class="form-control" ></input>
			<div class="input-group-btn">
				<button type="button" class="btn waves-effect waves-light" th:onclick="insertComment([[ ${board.boardNum} ]])">댓글등록
				</button>
			</div>
		</div>
		<ul class="notice-list">
		
		</ul>
	</form>
                
            </div>
            
            <!-- /.card-content -->
        </div>
        <!-- /.box-content -->
        
        
        <!-- 댓글칸 다른걸로 테스트.  -->
        <!-- Comments Form -->
<!-- 	<div class="card my-4"> -->
<!-- 		<h5 class="card-header">Leave a Comment:</h5> -->
<!-- 		<div class="card-body"> -->
<!-- 			<form name="comment-form" action="/board/comment/write" method="post" autocomplete="off"> -->
<!-- 				<div class="form-group"> -->
<!-- 					<input type="hidden" name="idx" th:value="*{idx}" /> -->
<!-- 					<textarea name="content" class="form-control" rows="3"></textarea> -->
<!-- 				</div> -->
<!-- 				<button type="submit" class="btn btn-primary">Submit</button> -->
<!-- 			</form> -->
<!-- 		</div> -->
<!-- 	</div> -->
      </body>
      
        <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
        
       <script th:inline="javascript">
       /*<![CDATA[*/
//        $(function() {
//     	   insertComment(); 
//        });
       
        function insertComment(boardNum) {
// 		console.log(boardNum);
        	var content = document.getElementById("content");
//         	 if (isEmpty(content.value) == true) { 
        		content.setAttribute("placeholder", "댓글을 입력해 주세요.");
        		content.focus();
//         		 return false; 
//         	  } 
//         	var uri = /*[[ @{/comments} ]]*/null;
        	var uri = "/comments" ;
        	var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "POST"};
        	var params = {"boardNum": boardNum, "commContents": content.value, "memId": "khb"};

        	$.ajax({
        		url: uri,
        		type: "POST",
        		headers: headers,
        		dataType: "json",
        		data: JSON.stringify(params),
        		success: function(response) {
        			if (response.result == false) {
        				alert("댓글 등록에 실패하였습니다.");
        				return false;
        			}

        			printCommentList();
        			content.value = "";
        		},
        		error: function(xhr, status, error) {
        			alert("에러가 발생하였습니다.");
        			return false;
        		}
        	});
        }
        /*[- end of function -]*/
        
        $(function() {
            printCommentList(); 
        });
        
        function printCommentList() {
        	//$.get(URL주소[,콜백함수]);
            //${board.~}는 컨트롤러에서 설정한 "board"에서 받아온 값 중 ~라는 속성을 꺼내온단 의미
            //클라이언트가 서버로 요청을 보낼 주소.             
            
           var uri = /*[[ @{/comments/} + ${board.boardNum}]]*/null;
//             console.log("hi");
            console.log("컨트롤러에서 받아온 값", /*[[${board.boardNum}]]*/);
           //$.get 좀 더 편한 ajax 처리. uri에 http get요청을 날려서 comments/{boardNum}을 요청.
           //서버에서 받아온 데이터(해당 게시글의 댓글 목록)이 response 인자에 담김.
            $.get(uri, function(response) {
            	console.log("response : "+response);
            	//댓글내용이 false값이 리턴 된다면(=response값이 null이나 empty값이 아니라면=데이터가 존재하면)
               // if (isEmpty(response) == false) {
                    //<li>태그를 제거한 것을 대신하여 새로 채워넣을 코드(=댓글 목록)의 시작
                    var commentsHtml = "";
                   
                    //for:each와 같은 문법. 댓글의 개수(=게시글에 달린 comm_num의 개수가 곧 댓글의 개수)만큼 반복문 실행
                  // $.each(arr, function (index, item) { 
                	  // 두 번째 매개변수로는 콜백함수인데 콜백함수의 매개변수 중 
                	    // 첫 번째 매개 변수 index는 배열의 인덱스 또는 객체의 키를 의미하고 
                	    // 두 번째 매개 변수 item은 해당 인덱스나 키가 가진 값을 의미합니다.
                  
                    $(response.commentList).each(function(commNum, comment) {
                        commentsHtml += `
                            <li>
                        	  	<span class="id">${comment.memId}</span>
                                <span class="nick">${comment.memNick}</span>
							 	<span class="conts">${comment.commContents}</span>  
                               
                                <button type="button" class="glyphicon glyphicon-pencil" id="btnCommentsDelete" onclick="deleteComment('${comment.commNum}')" >삭제<i class="fa fa-close" aria-hidden="true"></i></button>
                                <button type="button" class="btn btn-xs btn-circle" id="btnCommentsUpdate" onclick="updateComment('${comment.commNum}')">수정<i class="fa fa-close1" aria-hidden="true"></i></button>
                            </li>
                        `;
                    });
                	  
                    $(".notice-list").html(commentsHtml);
         	//	    }
            }, "json");
                    
        }
       
        /*[- end of function -]*/
    
        
      
            function deleteBoard(boardNum, memId, boardType) {

                if (confirm(boardNum + "번 게시글을 삭제할까요?")) {
                    var uri = "/board/freeboard/delete";
                    var html = "";

                    html += '<form name="dataForm" action="'+uri+'" method="get">';
                        html += '<input type="hidden" name="boardNum" value="'+boardNum+'" />';
                        html += '<input type="hidden" name="memId" value="'+memId+'" />';
                        html += '<input type="hidden" name="boardType" value="'+boardType+'" />';
                    html += '</form>';

                    $("body").append(html);
                    document.dataForm.submit();
                }
            }
            /*[- end of function -]*/
            
    function deleteComment(commNum) {
    	console.log("값 : " + commNum);
            if (!confirm('댓글을 삭제하시겠어요?')) {
			return false;
		}
            
            
// 		 var commNum = document.getElementById("commNum1").value;
//          commNum.innerHTML="바뀐html";
		var uri = /*[[ @{/comments/} ]]*/ + commNum;
		var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "DELETE"};
		
		$.ajax({
			url: uri,
			type: "DELETE",
			headers: headers,
			dataType: "json",
			success: function(response) {
				if (response.result == false) {
					alert("댓글 삭제에 실패하였습니다.");
					return false;
				}
	
				printCommentList();
	// 			$("#commentModal").modal("hide");
			},
			error: function(xhr, status, error) {
				alert("에러가 발생하였습니다.");
				return false;
			}
			});
		
	  }
            
//           function boardhitplus ()  {
        	  
//         	  var uri = "/board/freeboard/delete";
        	  
        	  
        	  
        	  
        	  
        	  
        	  
        	  
          
//           }
          
            
            
		   /*[- end of function -]*/
		/*]]>*/
        </script>
        
      
    
</html>