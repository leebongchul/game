<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">a
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>



<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<!-- 테마 -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<link href="/css/admin/noticeview.css" rel="stylesheet" type="text/css">

<head>
<meta charset="UTF-8">
<title>The page is a write page</title>
</head>

<body>
	<section class="content">
		<form class="form-horizontal form-view" th:object="${board}">
			<div id="main-content" class="blog-page">
				<h4 class="freeboard">자유게시판</h4>
				<div class="container">
					<div class="row clearfix">
						<div class="col-lg-12 col-md-12 left-box">
							<div class="card single_post">
								<div class="body">
									<form th:object="${board}">
										<input type="hidden" id="loginMemId" th:value="${member.memId}">
										<h3 th:text="*{boardTitle}" class="boardtitle"></h3>

										<div class="btn_wrap text-center btn_tot">

											<a th:href="@{/board/freeboard/write( boardNum=${board.boardNum}, boardType=${board.boardType}, memId=${board.memId} )}"
												class="btn btn-dark waves-effect waves-light btn_update">수정하기</a>
											<button type="button" class="btn btn-dark waves-effect waves-light btn_delete"
												th:onclick="deleteBoard([[ ${board.boardNum} ]], [[ ${board.memId} ]], [[ ${board.boardType} ]])">삭제하기</button>
										</div>
										<div class="col-sm-10, text-left">
										<span class="user-icons">
									<i class="bi bi-emoji-smile user-icon"></i>
									</span>
											<span class="dropdown">
												<button type="button" class="nickbtn btn-dark btn-nick-decl" data-bs-toggle="dropdown" aria-expanded="false">
													<span th:text="*{memNick}"></span>
												</button>
												&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <span th:text="*{boardDate}"></span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <span
													th:text="'조회수&nbsp&nbsp'+*{boardHit}"></span>
												<hr>

												<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
													<!-- Button trigger modal -->
													<li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#staticBackdrop" href="#">신고하기</a></li>
												</ul>
											</span>
										</div>
										<br> <br> <br>
										<p th:text="*{boardContent}"></p>
									</form>
									<br>
<!-- 									<div class="delet_board"> -->
<!-- <!-- 									//삭제 폼 들어감 -->
<!--                                     </div> -->


									<!-- Modal -->
									<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
										aria-labelledby="staticBackdropLabel" aria-hidden="true">
										<div class="modal-dialog">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title" id="staticBackdropLabel">
														<strong>사용자 신고</strong>
													</h5>
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<!-- 모달 내용 -->
												<div class="modal-body px-5">
													<h6 class="mb-3">
														<strong>신고 유형을 선택해주세요.</strong>
													</h6>
													<form name="repTypeForm" id="repTypeForm" action="/board/report" method="get">
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="음란"> <label class="form-check-label" for="flexRadioDefault1">
																성적인 컨텐츠 </label>
														</div>
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="광고"> <label class="form-check-label" for="flexRadioDefault2">
																광고 컨텐츠 </label>
														</div>
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="욕설"> <label class="form-check-label" for="flexRadioDefault1">
																욕설 또는 폭력적인 콘텐트 </label>
														</div>
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="사행성"> <label class="form-check-label"
																for="flexRadioDefault2"> 사행성 컨텐츠 </label>
														</div>
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="정치글"> <label class="form-check-label"
																for="flexRadioDefault1"> 정치적 컨텐츠 </label>
														</div>
														<div class="form-check my-2">
															<input class="form-check-input" type="radio" name="repType" value="분란"> <label class="form-check-label" for="flexRadioDefault2">
																분란 조장 컨텐츠 </label>
														</div>
														<input type="hidden" name="boardNum" th:value="${board.boardNum}"> <input type="hidden" name="boardType"
															th:value="${board.boardType}"> <input type="hidden" name="repId" th:value="${board.memId}">
													</form>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
													<button type="button" class="btn btn-primary" onclick="reportFormCheck()">확인</button>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="card">
								<div class="header">
									<h4 class="comment-write">댓글 작성</h4>
								</div>
								<div class="body">
									<div class="comment-form">
										<form class="row clearfix">
											<div class="col-sm-12">
												<div class="form-group">
													<span th:text="${member.memNick}" class="comment-nick" id="comment-nick"></span>
													<textarea rows="4" class="form-control no-resize view-textarea"
														th:placeholder="${member.memNick.equals('비회원')? '로그인을 해주세요' : '작성할 댓글 내용을 입력해주세요'}" id="content"></textarea>
													<!--  <button type="submit" class="btn btn-block btn-dark btn_insert">댓글 등록</button>-->
													<button type="button" class="btn waves-effect waves-light btn-insert"
														th:onclick="insertComment([[ ${board.boardNum} ]], [[ ${member.memId} ]], [[ ${member.memNick} ]])">댓글등록</button>
												</div>
											</div>
										</form>
									</div>
								</div>
							</div>
							<div class="card">
								<div class="header">
									<h2 class="comment-write">댓글</h2>
								</div>
								<ul class="notice-list">

								</ul>
								<!--  
											<div class="body">
												<ul class="comment-reply list-unstyled">
													
														<div class="text-box">
															<h5 class="m-b-0 user-name">김상명</h5>
															<p class="user-comment">댓글ㄹㄹㄹㄹ</p>
															
																<span class="user-date"><a href="javascript:void(0);">Mar 09 2018</a></span>
															
														
										<button type="button" class="btn btn-danger waves-effect waves-light btn_decl" data-bs-toggle="dropdown">신고</button>
										<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
										-->
								<!-- Button trigger modal -->
								<!--  
											<li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#staticBackdrop" href="#">신고하기</a></li>
										</ul>
														
														
														
														
														
													
													<hr>
														<div class="text-box">
															<h5 class="m-b-0 user-name">이봉철</h5>
															<p class="user-comment">댓글ㄹㄹㄹㄹ</p>
																<span class="user-date"><a href="javascript:void(0);" >Mar 12 2018</a></span>
															<button type="button" class="btn btn-danger waves-effect waves-light btn_decl" data-bs-toggle="dropdown">신고</button>
										<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
											-->
								<!-- Button trigger modal -->
								<!--  
											<li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#staticBackdrop" href="#">신고하기</a></li>
										</ul>
													<hr>
														<div class="text-box">
															<h5 class="m-b-0 user-name">정수연</h5>
															<p class="user-comment">댓글ㄹㄹㄹㄹ</p>
																<span class="user-date"><a href="javascript:void(0);" class="date">Mar 20 2018</a></span>
															<button type="button" class="btn btn-danger waves-effect waves-light btn_decl" data-bs-toggle="dropdown">신고</button>
										<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
											-->
								<!-- Button trigger modal -->
								<!--  
											<li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#staticBackdrop" href="#">신고하기</a></li>
										</ul>
													<hr>
												</ul>
											</div>
											
										</div>
										-->
							</div>
							<a onclick="history.back()" class="btn btn-dark waves-effect waves-light btn_back">목 록</a>
						</div>

					</div>
				</div>
		</form>
	</section>
</body>


<script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>

<script th:inline="javascript">
       
/*<![CDATA[*/       
        function insertComment(boardNum, loginId, loginNick) {
        	var content = document.getElementById("content");
        	
        	if(loginId==null){
        		alert("로그인이 필요합니다.");
        		return false;
        	}
        	
        	 if (content.value == "") { 
        		 alert("댓글을 입력해 주세요.");
//         		content.setAttribute("placeholder", "댓글을 입력해 주세요.");
        		content.focus();
        		 return false; 
        	  } 
        	 
        	var uri = "/comments" ;
        	var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "POST"};
        	var params = {"boardNum": boardNum, "commContents": content.value, "memId": loginId};

        	$.ajax({
        		url: uri,
        		type: "POST",
        		headers: headers,
        		dataType: "json",
        		jsonp: false,
        		data: JSON.stringify(params),
        		success: function(response) {
        			if (response.result == true) {
        				document.documentElement.scrollTop = document.body.scrollHeight;
        			}else {
        				alert("댓글 등록에 실패하였습니다.");
        				return false;
        			}

        			printCommentList();
        			content.value = "";
        		},
        		error: function(xhr, status, error) {
        			alert("에러가 발생하였습니다.");
        			return false;
        		}
        	});
        }
        /*[- end of function -]*/
        
        $(function() {
            printCommentList(); 
        });
        
        function printCommentList() {
        	//$.get(URL주소[,콜백함수]);
            //${board.~}는 컨트롤러에서 설정한 "board"에서 받아온 값 중 ~라는 속성을 꺼내온단 의미
            //클라이언트가 서버로 요청을 보낼 주소.             
            
           var uri = /*[[ @{/comments/} + ${board.boardNum}]]*/null;
            var loginMemId=document.getElementById("loginMemId").value;
//             console.log("hi");

           //$.get 좀 더 편한 ajax 처리. uri에 http get요청을 날려서 comments/{boardNum}을 요청.
           //서버에서 받아온 데이터(해당 게시글의 댓글 목록)이 response 인자에 담김.
//              console.log("컨트롤러에서 받아온 값", /*[[${board.boardNum}]]*/);
           
            $.get(uri, function(response) {
            	console.log("response : "+response.commentList[0].commNum);
            	
            	//댓글내용이 false값이 리턴 된다면(=response값이 null이나 empty값이 아니라면=데이터가 존재하면)
               // if (isEmpty(response) == false) {
                    //<li>태그를 제거한 것을 대신하여 새로 채워넣을 코드(=댓글 목록)의 시작
                    
                    var commentsHtml = "";
                   
                    //for:each와 같은 문법. 댓글의 개수(=게시글에 달린 comm_num의 개수가 곧 댓글의 개수)만큼 반복문 실행
                  // $.each(arr, function (index, item) { 
                	  // 두 번째 매개변수로는 콜백함수인데 콜백함수의 매개변수 중 
                	    // 첫 번째 매개 변수 index는 배열의 인덱스 또는 객체의 키를 의미하고 
                	    // 두 번째 매개 변수 item은 해당 인덱스나 키가 가진 값을 의미합니다.
                  
                    $(response.commentList).each(function(commNum, comment) {
                    	commentsHtml += `
                            <li id="${comment.commNum}">
                                <span class="nick" id="commNick" >${comment.memNick}</span>
                                <span class="conts" id="commConts">${comment.commContents}</span>`;
                                
                                
                           if(/*[[${member.memNick}]]*/null == "비회원"){
                           	 if(comment.memId==/*[[${member.memId}]]*/null){
                           		
                           	  commentsHtml += `
                                  <button id="btnCommentsDelete" onclick="deleteComment('${comment.commNum}')" >삭제<i class="fa fa-close" aria-hidden="true"></i></button>
                                  <button id="btnCommentsUpdate" onclick="beforeupdate('${comment.commNum}', '${comment.commContents}', '${comment.memNick}')">수정<i class="fa fa-close1" aria-hidden="true"></i></button>
                             `;
                                }
                           }
                               
                          commentsHtml += `
                        	  </li>
                              <hr> `;
                    });
                	  
                    $(".notice-list").html(commentsHtml);
//                     $("body").append(commentsHtml);
            }, "json")
                    
        }
    
        
      
      function deleteBoard(boardNum, memId, boardType) {

          if (confirm(boardNum + "번 게시글을 삭제할까요?")) {
              var uri = "/board/freeboard/delete";
              var html = "";

              html += '<form name="dataForm" action="'+uri+'" method="get">';
                  html += '<input type="hidden" name="boardNum" value="'+boardNum+'" />';
                  html += '<input type="hidden" name="memId" value="'+memId+'" />';
                  html += '<input type="hidden" name="boardType" value="'+boardType+'" />';
              html += '</form>';
//               $(".delet_board").html(html);
              
              $("body").append(html);
              document.dataForm.submit();
          }
      }
            
            
    function deleteComment(commNum) {
    	console.log("값 : " + commNum);
            if (!confirm('댓글을 삭제하시겠어요?')) {
			return false;
		}
            
            
		var uri = "/comments/" + commNum;
		var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "DELETE"};
		
		$.ajax({
			url: uri,
			type: "DELETE",
			headers: headers,
			dataType: "json",
			success: function(response) {
				if (response.result == false) {
					alert("댓글 삭제에 실패하였습니다.");
					return false;
				}
	
				printCommentList();
			},
			error: function(xhr, status, error) {
				alert("에러가 발생하였습니다.");
				return false;
			}
			});
		
	  }
    /*[- end of function -]*/
            
    
    function beforeupdate(commNum, commContents, memNick) {
    	console.log(commNum +"의 수정버튼을 눌렀습니다");
    
    let change ="";
    change += `
    	 
    <li class="">
        <span class="nick">${memNick}</span>
	 	<span class="conts" ><input type="text" class="conts1" placeholder="${commContents}" id="tex" ><p/input></span>
       
	 	<button type="button" class="glyphicon glyphicon-pencil" id="btnCommentsDelete" onclick="printCommentList()" >취소<i class="fa fa-close" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-xs btn-circle" id="btnCommentsUpdate" onclick="updateComment('${commNum}')">수정완료<i class="fa fa-close1" aria-hidden="true"></i></button>
    </li>
    `;
    
    
    $('#'+commNum).replaceWith(change);
    $('.conts1').focus();
    };
    
    
    
    
    function updateComment(commNum) {
    	
    var text = document.getElementById("tex");
    var uri = /*[[ @{/comments/} ]]*/ null + commNum;
    var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "PATCH"};
    var params = {"commNum": commNum, "memId": /*[[${member.memId}]]*/null, "commContents": text.value};
	console.log("수정완료 버튼을 누른뒤의 값: "+text.value);
    
    $.ajax({
        url: uri,
        type: "PATCH",
        headers: headers,
        dataType: "json",
        data: JSON.stringify(params),
        success: function(response) {
            if (response.result == false) {
                alert("댓글 수정에 실패하였습니다.");
                return false;
            }

            printCommentList();
//             $("#commentModal").modal("hide");
        },
        error: function(xhr, status, error) {
            alert("에러가 발생하였습니다.");
            return false;
        }
    });
		   }	
		/*]]>*/
</script>

</html>